rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Función para verificar si el usuario es administrador.
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'berrojalbizjulieta@gmail.com';
    }

    // Reglas para la colección 'users'
    match /users/{userId} {
      // El dueño del documento o un admin puede leer y escribir.
      allow read, write: if request.auth.uid == userId || isAdmin();
    }

    // Reglas para la colección 'professionalsDetails'
    match /professionalsDetails/{profId} {
      allow read: if true; // Cualquiera puede leer el perfil.

      // El dueño puede crear y borrar su perfil.
      allow create, delete: if request.auth.uid == profId;

      // Se permite la actualización si:
      // 1. Es el dueño del perfil (puede cambiar cualquier cosa).
      // 2. Es la Cloud Function actualizando el rating (cualquier usuario autenticado puede hacerlo).
      allow update: if request.auth.uid == profId || (request.auth != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['avgRating', 'totalReviews']));
    }

    // Reglas para la colección 'reviews' (como colección principal)
    match /reviews/{reviewId} {
      allow read: if true; // Todos pueden leer las reseñas.
      allow create: if request.auth != null; // Cualquier usuario autenticado puede crear una reseña.
      allow update, delete: if false; // Nadie puede modificar o borrar reseñas.
    }

    // Reglas para la colección 'jobRequests'
    match /jobRequests/{jobId} {
      allow read: if true; // Todos pueden leer las solicitudes de trabajo.
      // El creador de la solicitud es el único que puede crear, actualizar o borrar.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.clientId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.clientId;
    }

    // Reglas para la colección 'adBanners'
    match /adBanners/{bannerId} {
      allow read: if true; // Todos pueden leer los banners.
      // Solo el administrador puede escribir (crear, actualizar, borrar).
      allow write: if isAdmin();
    }
  }
}
