rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regla para la colección 'users':
    // 1. Permite leer su propio documento a cualquier usuario autenticado.
    // 2. Permite a los administradores leer o escribir en cualquier documento de usuario.
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Regla para la colección 'professionalsDetails':
    // 1. Cualquiera puede leer los perfiles (para que sean públicos).
    // 2. Solo el profesional dueño del perfil o un administrador pueden escribir/actualizar.
    match /professionalsDetails/{profId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == profId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Regla para la colección 'reviews':
    // 1. Cualquiera puede leer las reseñas.
    // 2. Solo un usuario autenticado puede crear o actualizar su propia reseña (el id del documento es userId_profId).
    match /reviews/{reviewId} {
        allow read: if true;
        allow create, update: if request.auth != null && request.auth.uid == reviewId.split('_')[0];
    }

    // Regla para la colección 'jobRequests' (Anuncios de "Busco un profesional"):
    // 1. Cualquier usuario autenticado puede leer los anuncios.
    // 2. Solo los usuarios autenticados pueden crear anuncios.
    // 3. Solo el creador del anuncio o un admin puede actualizarlo o borrarlo.
    match /jobRequests/{jobId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && (resource.data.clientId == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // Regla para la colección 'adBanners' (banners de publicidad):
    // 1. Cualquiera puede leer los banners.
    // 2. Solo un administrador puede crear, actualizar o borrar banners.
    match /adBanners/{bannerId} {
        allow read: if true;
        allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // REGLA NUEVA Y CORREGIDA para la colección 'analytics':
    // 1. Cualquiera puede escribir (necesario para que la API de visitas funcione para todos).
    //    Es seguro porque el endpoint solo permite incrementar un contador.
    // 2. Solo los administradores pueden leer los datos.
    match /analytics/{docId} {
      allow write: if true;
      allow read: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
